#!/usr/bin/env bash
set -euo pipefail

# bd-finalize: Commit work in the current repo, close the ticket in
# photoop-product, and push both repos.
#
# Usage: bd-finalize <ticket_id> <commit_message_file> <file>...
#
# Because issue tracking is centralized in photoop-product, this script
# handles the split: code is committed in the working repo while bd
# close / bd sync happen in photoop-product.

PRODUCT_DIR="$HOME/photoop-product"

if [[ $# -lt 3 ]]; then
  echo "Usage: bd-finalize <ticket_id> <commit_message_file> <file>..." >&2
  exit 1
fi

ticket_id="$1"
shift
commit_message_file="$1"
shift

if [[ ! -f "$commit_message_file" ]]; then
  echo "Commit message file not found: $commit_message_file" >&2
  exit 1
fi

# --- Safety gate: require explicit confirmation ---
if [[ "${BD_FINALIZE_CONFIRMED:-}" != "yes" ]]; then
  echo ""
  echo "=== bd-finalize: Pre-flight summary ==="
  echo "Ticket:       $ticket_id"
  echo "Commit msg:   $(cat "$commit_message_file")"
  echo "Files to add: $@"
  echo "Actions:      git commit + push (working repo), bd close + push (photoop-product)"
  echo ""
  echo "To execute, re-run with BD_FINALIZE_CONFIRMED=yes or set that env var."
  echo "If called from Amp, the agent MUST ask the user for approval first."
  exit 0
fi

# --- Working repo: commit the code changes ---
git add "$@"
git commit -F "$commit_message_file"
rm "$commit_message_file"

# Amend if pre-commit hooks modified files
git add -A
if ! git diff --cached --quiet; then
  git commit --amend --no-edit
fi

# Push working repo
git pull --rebase
git push

# --- photoop-product: close ticket and sync ---
(
  cd "$PRODUCT_DIR"
  bd close "$ticket_id"
  git add -A
  if ! git diff --cached --quiet; then
    git commit -m "Close $ticket_id"
  fi
  bd sync
  git pull --rebase
  git push
)

echo "✓ Finalized $ticket_id — both repos pushed."
