#!/usr/bin/env bash
set -euo pipefail

# bd-next: Fetch the next ready ticket from photoop-product and output
# an Amp prompt that starts a new thread for it.
#
# All bd commands run against photoop-product (the central tracker).
# The ticket's label determines which repo to work in.

PRODUCT_DIR="$HOME/photoop-product"

override_id="${1:-}"

if [[ -n "$override_id" && "$override_id" != "_" && "$override_id" != "-" ]]; then
  next_id="$override_id"
else
  next_id=$(cd "$PRODUCT_DIR" && bd ready --json | jq -r '.[0].id')
fi

if [[ -z "${next_id:-}" || "$next_id" == "null" ]]; then
  echo "No ready tickets found."
  exit 1
fi

# Mark the ticket as in-progress so concurrent bd-next calls won't pick it
(cd "$PRODUCT_DIR" && bd update "$next_id" --status in_progress)

# Determine the target repo from the ticket's label
ticket_json=$(cd "$PRODUCT_DIR" && bd show "$next_id" --json)
label=$(echo "$ticket_json" | jq -r '.[0].labels[0] // empty')

case "$label" in
  photoop-app)            work_dir="$HOME/photoop-app" ;;
  photoop-backend)        work_dir="$HOME/photoop-backend" ;;
  photoop-infrastructure) work_dir="$HOME/photoop-infrastructure" ;;
  *)                      work_dir="$HOME/photoop-product" ;;
esac

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Build the label context line
if [[ "$work_dir" == "$HOME/photoop-product" ]]; then
  label_line="- This ticket has no repo label, so it is product-level work done in photoop-product itself. Code changes happen in ${work_dir}."
else
  label_line="- This ticket is labeled for $(basename "$work_dir"). Code changes happen in ${work_dir}."
fi

# Build the handoff goal (instructions for the new thread)
handoff_goal="Continuing work from thread CURRENT_THREAD_URL. When you lack specific information you can use read_thread to get it.

- I want to start working on Beads ticket ${next_id}.
- All bd CLI commands (ready, show, close, sync, create, update) MUST be run from ~/photoop-product.
${label_line}
- Steps to follow:
  1. cd ${work_dir} and run: bd sync && bd show ${next_id} --json
  2. Restate and expand the acceptance criteria / definition of done from the ticket.
  3. If it makes sense, break work into sub-tasks, creating new bd tickets (in ~/photoop-product) with appropriate dependencies.
  4. Execute the work in ${work_dir}, filing any follow-ups as new bd tickets in ~/photoop-product.
  5. STOP before committing. Present a summary of changes, proposed commit message, the ticket being closed (${next_id}), and which repos will be pushed. Ask me for explicit approval before proceeding.
  6. Only after I approve: finalize using ${SCRIPT_DIR}/bd-finalize ${next_id} <commit_message_file> <files...>
- NEVER run git commit, git push, bd close, or bd-finalize without my explicit approval.

Load skills: bd-next"

cat <<PROMPT
Start the next Beads ticket: ${next_id}.

Use the handoff tool to create a new thread with follow: true. Replace CURRENT_THREAD_URL in the goal with the actual Amp Thread URL from this thread's context.

Handoff goal:

${handoff_goal}
PROMPT
